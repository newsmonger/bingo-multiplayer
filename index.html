<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multiplayer Bingo</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: sans-serif; margin: 0; background: #121212; color: #f0f0f0; }
    .bingo-card { display: flex; flex-direction: column; align-items: center; width: 240px; margin: 40px auto; padding: 10px; background: #1e1e1e; border-radius: 8px; }
    .square { width: 100%; padding: 10px; margin: 4px 0; background: #2a2a2a; text-align: center; cursor: pointer; border-radius: 4px; }
    .marked { background: #4caf50; text-decoration: line-through; color: white; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="bingo-card" id="card"></div>
  <audio id="chime" src="win-chime.mp3" preload="auto"></audio>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDPKpLipcgz25gKsoeAi_Vo9kf7dLrWkLc",
      authDomain: "bingo-multiplayer-d4139.firebaseapp.com",
      projectId: "bingo-multiplayer-d4139",
      storageBucket: "bingo-multiplayer-d4139.firebasestorage.app",
      messagingSenderId: "993509419940",
      appId: "1:993509419940:web:67a0ea1738c7aa32ff6f31",
      measurementId: "G-BJ5YS9CHQB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get("gameId") || "testgame";
    const cardId = urlParams.get("cardId") || "player1";

    const ref = db.collection("bingoGames").doc(gameId).collection("cards").doc(cardId);
    const container = document.getElementById("card");

    const defaultSquares = Array(15).fill().map((_, i) => ({ label: "Item " + (i+1), marked: false }));
    defaultSquares.splice(7, 0, { label: "FREE SPACE", marked: true });

    function render(squares) {
      container.innerHTML = "";
      squares.forEach((sq, i) => {
        const div = document.createElement("div");
        div.className = "square" + (sq.marked ? " marked" : "");
        div.textContent = sq.label;
        div.onclick = () => {
          squares[i].marked = !sq.marked;
          ref.set({ squares });
        };
        container.appendChild(div);
      });
      if (checkWin(squares)) document.getElementById("chime").play();
    }

    function checkWin(sq) {
      const marked = i => sq[i] && sq[i].marked;
      return (
        [0,1,2,3].every(marked) || [4,5,6,7].every(marked) ||
        [8,9,10,11].every(marked) || [12,13,14,15].every(marked) ||
        [0,4,8,12].every(marked) || [3,6,9,12].every(marked)
      );
    }

    ref.get().then(doc => {
      if (doc.exists) render(doc.data().squares);
      else ref.set({ squares: defaultSquares }).then(() => render(defaultSquares));
    });

    ref.onSnapshot(doc => {
      if (doc.exists) render(doc.data().squares);
    });
  </script>
</body>
</html>
