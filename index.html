<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multiplayer Bingo</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #121212; color: #f0f0f0; }
    header { text-align: center; padding: 10px; background: #1e1e1e; }
    input, button { padding: 8px; margin: 4px; }
    #setup, #cards { display: none; max-width: 600px; margin: auto; padding: 20px; }
    .bingo-card { background: #1e1e1e; padding: 10px; margin: 20px auto; border-radius: 8px; width: fit-content; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
    .square { background: #2a2a2a; padding: 10px; text-align: center; cursor: pointer; border-radius: 4px; }
    .marked { background: #4caf50; color: white; text-decoration: line-through; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <header><h1>Multiplayer Bingo ðŸŽ‰</h1></header>

  <div id="setup">
    <label>Game ID: <input id="gameId" value="testgame"/></label><br/>
    <label>Card ID: <input id="cardId" value="player1"/></label><br/>
    <label>Card Title: <input id="cardTitle" value="Fun Bingo"/></label><br/>
    <label>Enter 15 items (1 per line):</label><br/>
    <textarea id="entries" rows="8" cols="30">Item 1
Item 2
Item 3
Item 4
Item 5
Item 6
Item 7
Item 8
Item 9
Item 10
Item 11
Item 12
Item 13
Item 14
Item 15</textarea><br/>
    <button onclick="startGame()">Generate Card</button>
  </div>

  <div id="cards">
    <h2 id="cardTitleDisplay"></h2>
    <div class="bingo-card"><div class="grid" id="cardGrid"></div></div>
  </div>

  <audio id="chime" src="win-chime.mp3" preload="auto"></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDPKpLipcgz25gKsoeAi_Vo9kf7dLrWkLc",
      authDomain: "bingo-multiplayer-d4139.firebaseapp.com",
      projectId: "bingo-multiplayer-d4139",
      storageBucket: "bingo-multiplayer-d4139.firebasestorage.app",
      messagingSenderId: "993509419940",
      appId: "1:993509419940:web:67a0ea1738c7aa32ff6f31",
      measurementId: "G-BJ5YS9CHQB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const setupEl = document.getElementById("setup");
    const cardsEl = document.getElementById("cards");
    const gridEl = document.getElementById("cardGrid");
    const chime = document.getElementById("chime");

    const url = new URLSearchParams(window.location.search);
    const gameIdParam = url.get("gameId");
    const cardIdParam = url.get("cardId");
    if (!gameIdParam || !cardIdParam) setupEl.style.display = "block";

    async function startGame() {
      const gameId = document.getElementById("gameId").value.trim();
      const cardId = document.getElementById("cardId").value.trim();
      const title = document.getElementById("cardTitle").value.trim();
      const raw = document.getElementById("entries").value.split("\n").map(s => s.trim()).filter(s => s);
      if (raw.length !== 15) return alert("Enter exactly 15 items!");
      raw.splice(7, 0, "FREE SPACE");
      const squares = raw.map(label => ({ label, marked: label === "FREE SPACE" }));
      await db.collection("bingoGames").doc(gameId).collection("cards").doc(cardId).set({ squares, title });
      location.href = `?gameId=${gameId}&cardId=${cardId}`;
    }

    async function loadCard(gameId, cardId) {
      const ref = db.collection("bingoGames").doc(gameId).collection("cards").doc(cardId);
      ref.onSnapshot(doc => {
        const data = doc.data();
        if (!data || !data.squares) return;
        gridEl.innerHTML = "";
        document.getElementById("cardTitleDisplay").textContent = data.title || "Bingo Card";
        data.squares.forEach((sq, i) => {
          const div = document.createElement("div");
          div.className = "square" + (sq.marked ? " marked" : "");
          div.textContent = sq.label;
          div.onclick = () => {
            data.squares[i].marked = !sq.marked;
            ref.set(data);
            if (checkWin(data.squares)) chime.play();
          };
          gridEl.appendChild(div);
        });
      });
      setupEl.style.display = "none";
      cardsEl.style.display = "block";
    }

    function checkWin(squares) {
      const win = [
        [0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15],
        [0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15],
        [0,5,10,15],[3,6,9,12]
      ];
      return win.some(pattern => pattern.every(i => squares[i] && squares[i].marked));
    }

    if (gameIdParam && cardIdParam) loadCard(gameIdParam, cardIdParam);
  </script>
</body>
</html>
