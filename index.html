<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multiplayer Bingo</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #121212; color: #f0f0f0; }
    header { text-align: center; padding: 10px; background: #1e1e1e; }
    input, button, textarea, select { padding: 8px; margin: 6px 0; width: 100%; box-sizing: border-box; }
    #creator, #card { max-width: 500px; margin: auto; display: none; padding: 20px; }
    .bingo-card { background: #1e1e1e; padding: 10px; margin: 20px auto; border-radius: 8px; width: fit-content; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
    .square { background: #2a2a2a; padding: 10px; text-align: center; cursor: pointer; border-radius: 4px; }
    .marked { background: #4caf50; color: white; text-decoration: line-through; }
    .winner { text-align: center; font-weight: bold; color: #4caf50; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <header><h1>Multiplayer Bingo ðŸŽ‰</h1></header>

  <div id="creator">
    <label>Game ID: <input id="gameId"/></label><br/>
    <label>Card Title: <input id="title"/></label><br/>
    <label>Number of Players: <input type="number" id="numPlayers" min="1" value="5"/></label><br/>
    <label>15 Items (1 per line):<br/>
      <textarea id="entries" rows="8">Item 1
Item 2
Item 3
Item 4
Item 5
Item 6
Item 7
Item 8
Item 9
Item 10
Item 11
Item 12
Item 13
Item 14
Item 15</textarea>
    </label><br/>
    <button onclick="createGame()">Generate Game</button>
    <div id="shareLinks"></div>
  </div>

  <div id="card">
    <h2 id="cardTitleDisplay"></h2>
    <div class="bingo-card"><div class="grid" id="cardGrid"></div></div>
    <div id="winner" class="winner"></div>
  </div>

  <audio id="chime" src="win-chime.mp3" preload="auto"></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDPKpLipcgz25gKsoeAi_Vo9kf7dLrWkLc",
      authDomain: "bingo-multiplayer-d4139.firebaseapp.com",
      projectId: "bingo-multiplayer-d4139",
      storageBucket: "bingo-multiplayer-d4139.firebasestorage.app",
      messagingSenderId: "993509419940",
      appId: "1:993509419940:web:67a0ea1738c7aa32ff6f31",
      measurementId: "G-BJ5YS9CHQB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const url = new URLSearchParams(location.search);
    const gameId = url.get("gameId");
    const cardId = url.get("cardId");

    const creatorEl = document.getElementById("creator");
    const cardEl = document.getElementById("card");
    const gridEl = document.getElementById("cardGrid");
    const chime = document.getElementById("chime");
    const winnerEl = document.getElementById("winner");
    const cardTitleEl = document.getElementById("cardTitleDisplay");

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    async function createGame() {
      const game = document.getElementById("gameId").value.trim();
      const title = document.getElementById("title").value.trim();
      const num = parseInt(document.getElementById("numPlayers").value, 10);
      const raw = document.getElementById("entries").value.split("\n").map(s => s.trim()).filter(Boolean);
      if (raw.length !== 15 || !game || !title || !num) return alert("Please complete all fields correctly.");

      const links = [];
      for (let i = 1; i <= num; i++) {
        const cardItems = shuffle(raw);
        cardItems.splice(7, 0, "FREE SPACE");
        const squares = cardItems.map(label => ({ label, marked: label === "FREE SPACE" }));
        const cardData = { squares, title, winner: false };
        const cardId = `player${i}`;
        await db.collection("bingoGames").doc(game).collection("cards").doc(cardId).set(cardData);
        const url = `${location.origin + location.pathname}?gameId=${game}&cardId=${cardId}`;
        links.push(`<div><a href="${url}" target="_blank">${cardId}</a></div>`);
      }
      document.getElementById("shareLinks").innerHTML = "<h3>Share These Links:</h3>" + links.join("");
    }

    function checkWin(squares) {
      const patterns = [
        [0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15],
        [0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15],
        [0,5,10,15],[3,6,9,12]
      ];
      return patterns.some(p => p.every(i => squares[i]?.marked));
    }

    async function loadCard(gameId, cardId) {
      const ref = db.collection("bingoGames").doc(gameId).collection("cards").doc(cardId);
      ref.onSnapshot(doc => {
        const data = doc.data();
        if (!data?.squares) return;
        gridEl.innerHTML = "";
        cardTitleEl.textContent = data.title || "Bingo Card";
        data.squares.forEach((sq, i) => {
          const div = document.createElement("div");
          div.className = "square" + (sq.marked ? " marked" : "");
          div.textContent = sq.label;
          div.onclick = () => {
            data.squares[i].marked = !sq.marked;
            ref.set(data);
            if (checkWin(data.squares)) {
              chime.play();
              ref.update({ winner: true });
            }
          };
          gridEl.appendChild(div);
        });
      });
      cardEl.style.display = "block";
    }

    if (gameId && cardId) {
      loadCard(gameId, cardId);
    } else {
      creatorEl.style.display = "block";
    }
  </script>
</body>
</html>
